{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} | ÉvénementsCo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/event-detail.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}

<div class="event-detail-container">
    <div class="event-header">
        <div class="event-header-content">
            <h1>{{ event.title }}</h1>
            <div class="event-meta">
                <div class="event-meta-item">
                    <i class="fas fa-calendar"></i> 
                    <span>{{ event.date|date:"l d F Y" }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-clock"></i>
                    <span>{{ event.date|date:"H:i" }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ event.location }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>{{ event.remaining_seat }} places restantes</span>
                </div>
            </div>
        </div>
        <div class="event-actions">
            <button class="like-btn" data-event-id="{{ event.id }}">
                <i class="far fa-heart"></i>
            </button>
            <span class="likes-count">{{ event.likes_count|default:0 }}</span>
        </div>
    </div>

    <div class="event-main">
        <div class="event-info-container">
            <div class="event-image">
                {% if event.image %}
                <img src="data:image/png;base64,{{ event.image }}" alt="{{ event.title }}">
                {% else %}
                <img src="{% static 'images/default-event.jpg' %}" alt="{{ event.title }}">
                {% endif %}
            </div>
            
            <div class="event-description">
                <h2>À propos de cet événement</h2>
                <p>{{ event.description }}</p>
            </div>
        </div>

        <div class="event-sidebar">
            <div class="ticket-box">
                <h3>Réserver votre place</h3>
                {% if event.price > 0 %}
                <div class="price">{{ event.price }} F CFA par personne</div>
                {% else %}
                <div class="price free">Entrée gratuite</div>
                {% endif %}
                
                <form method="post" action="{% url 'register_for_event' event_id=event.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="name">Nom complet</label>
                        <input type="text" name="name" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="num_seats">Nombre de places</label>
                        <input type="number" name="num_seats" id="num_seats" min="1" value="1" max="{{ event.remaining_seats }}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            {% if event.price > 0 %}
                            Réserver et payer
                            {% else %}
                            Réserver gratuitement
                            {% endif %}
                        </button>
                        <button type="submit" class="btn btn-primary btn-block btn2">
                            Inviter un ami
                        </button>
                    </div>
                </form>
                
                <div class="ticket-footer">
                    <p><i class="fas fa-info-circle"></i> Les places sont attribuées par ordre d'arrivée</p>
                </div>
            </div>
        </div>
    </div>

    <div class="event-comments">
        <h2>Commentaires ({{ comments|length }})</h2>
        
        <div class="comment-form">
            <h3>Ajouter un commentaire</h3>
            <form method="post" action="{% url 'add_comment' event_id=event.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" rows="4" placeholder="Votre commentaire..." required></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-secondary">Publier</button>
                </div>
            </form>
        </div>
        
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <div class="comment-author">
                        {% if comment.user.profile_image %}
                        <img src="{{ comment.user.profile_image }}" alt="{{ comment.user }}" class="comment-avatar">
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ comment.user.first_name|default:comment.user }}&background=random&rounded=true" alt="{{ comment.user }}" class="comment-avatar">
                        {% endif %}
                        <span>{{ comment.user }}</span>
                    </div>
                    <div class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</div>
                </div>
                <div class="comment-content">
                    <p>{{ comment.content }}</p>
                </div>
            </div>
            {% empty %}
            <div class="no-comments">
                <p>Aucun commentaire pour l'instant. Soyez le premier à commenter !</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Code pour gérer les likes (simulé pour le frontend)
    // function initLikeButtons() {
    //     document.querySelectorAll('.like-btn').forEach(button => {
    //         button.addEventListener('click', function() {
    //             const eventId = this.dataset.eventId;
    //             const icon = this.querySelector('i');
    //             const likesCount = this.parentElement.querySelector('.likes-count');

    //             // Simuler l'alternance de l'icône de like
    //             if (icon.classList.contains('far')) {
    //                 icon.classList.remove('far');
    //                 icon.classList.add('fas');
    //                 icon.classList.add('liked');
    //                 likesCount.textContent = parseInt(likesCount.textContent) + 1;
    //             } else {
    //                 icon.classList.remove('fas');
    //                 icon.classList.remove('liked');
    //                 icon.classList.add('far');
    //                 likesCount.textContent = parseInt(likesCount.textContent) - 1;
    //             }

    //             // En production, ceci serait un appel AJAX au backend
    //             console.log(`Like toggled for event ${eventId}`);
    //         });
    //     });
    // }
    
    // // Initialiser les boutons de like au chargement initial
    // initLikeButtons();


document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.like-btn').forEach(button => {
            button.addEventListener('click', function () {
                const eventId = this.dataset.eventId;
                const icon = this.querySelector('i');
                const likesCountElem = this.parentElement.querySelector('.likes-count');

                fetch(`/events/${eventId}/like/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.action === 'liked') {
                            icon.classList.remove('far');
                            icon.classList.add('fas', 'liked');
                        } else {
                            icon.classList.remove('fas', 'liked');
                            icon.classList.add('far');
                        }
                        likesCountElem.textContent = data.likes_count;
                    }
                })
                .catch(error => console.error('Erreur lors du like:', error));
            });
        });

        // Fonction pour lire le token CSRF depuis les cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });


    



    // Validation du formulaire de réservation
    document.querySelector('.ticket-box form').addEventListener('submit', function(e) {
        const numSeats = parseInt(document.getElementById('num_seats').value);
        const maxSeats = parseInt(document.getElementById('num_seats').getAttribute('max'));
        
        if (numSeats <= 0) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins une place.');
        } else if (numSeats > maxSeats) {
            e.preventDefault();
            alert(`Il ne reste que ${maxSeats} places disponibles.`);
        }
    });
</script>
{% endblock %}
