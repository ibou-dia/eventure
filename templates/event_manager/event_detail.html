{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} | ÉvénementsCo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/event-detail.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}

<div class="event-detail-container">
    <div class="event-header">
        <div class="event-header-content">
            <h1>{{ event.title }}</h1>
            <div class="event-meta">
                <div class="event-meta-item">
                    <i class="fas fa-calendar"></i> 
                    <span>{{ event.date|date:"l d F Y" }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-clock"></i>
                    <span>{{ event.date|date:"H:i" }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>{{ event.location }}</span>
                </div>
                <div class="event-meta-item">
                    <i class="fas fa-ticket-alt"></i>
                    <span>{{ event.remaining_seat }} places restantes</span>
                </div>
            </div>
        </div>
        <div class="event-actions">
            {% if request.is_authenticated %}
            <button class="like-btn" data-event-id="{{ event.id }}">
                {% if user_has_liked %}
                    <i class="fas fa-heart text-red"></i>
                {% else %}
                    <i class="far fa-heart"></i>
                {% endif %}
            </button>
            {% else %}
            <a href="{% url 'login' %}?next={{ request.path }}" class="like-btn-login">
                <i class="far fa-heart"></i>
            </a>
            {% endif %}
            <span class="likes-count">{{ event.likes_count|default:0 }}</span>

        </div>
    </div>

    <div class="event-main">
        <div class="event-info-container">
            <div class="event-image">
                {% if event.image %}
                <img src="data:image/png;base64,{{ event.image }}" alt="{{ event.title }}">
                {% else %}
                <img src="{% static 'images/default-event.jpg' %}" alt="{{ event.title }}">
                {% endif %}
            </div>
            
            <div class="event-description">
                <h2>À propos de cet événement</h2>
                <p>{{ event.description }}</p>
            </div>
        </div>

        <div class="event-sidebar">
            <div class="ticket-box">
                <h3>Réserver votre place</h3>
                {% if event.price > 0 %}
                <div class="price">{{ event.price }} F CFA par personne</div>
                {% else %}
                <div class="price free">Entrée gratuite</div>
                {% endif %}
                
                {% if request.is_authenticated %}
                <form method="post" action="{% url 'register_for_event' event_id=event.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="name">Nom complet</label>
                        <input type="text" name="name" id="name" value="{{ request.user.username }}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" value="{{ request.user.email }}" required>
                    </div>
                    <div class="form-group">
                        <label for="num_seats">Nombre de places</label>
                        <input type="number" name="num_seats" id="num_seats" min="1" value="1" max="{{ event.remaining_seats }}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            {% if event.price > 0 %}
                            Réserver et payer
                            {% else %}
                            Réserver gratuitement
                            {% endif %}
                        </button>
                        <button type="submit" class="btn btn-primary btn-block btn2">
                            Inviter un ami
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="login-required">
                    <p>Vous devez être connecté pour réserver cet événement.</p>
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary btn-block">Se connecter pour réserver</a>
                </div>
                {% endif %}
                
                <div class="ticket-footer">
                    <p><i class="fas fa-info-circle"></i> Les places sont attribuées par ordre d'arrivée</p>
                </div>
            </div>
        </div>
    </div>

    <div class="event-comments">
        <h2>Commentaires ({{ comments|length }})</h2>
        
        <div class="comment-form">
            <h3>Ajouter un commentaire</h3>
            {% if request.is_authenticated %}
            <form method="post" action="{% url 'add_comment' event_id=event.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" rows="4" placeholder="Votre commentaire..." required></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-secondary">Publier</button>
                </div>
            </form>
            {% else %}
            <div class="login-required">
                <p>Vous devez être connecté pour laisser un commentaire.</p>
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary">Se connecter</a>
            </div>
            {% endif %}
        </div>
        
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <div class="comment-author">
                        {% if comment.user.profile_image %}
                        <img src="{{ comment.user.profile_image }}" alt="{{ comment.user }}" class="comment-avatar">
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ comment.user.first_name|default:comment.user }}&background=random&rounded=true" alt="{{ comment.user }}" class="comment-avatar">
                        {% endif %}
                        <span>{{ comment.user }}</span>
                    </div>
                    <div class="comment-date">{{ comment.created_at|date:"d/m/Y H:i" }}</div>
                </div>
                <div class="comment-content">
                    <p>{{ comment.content }}</p>
                </div>
            </div>
            {% empty %}
            <div class="no-comments">
                <p>Aucun commentaire pour l'instant. Soyez le premier à commenter !</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const likeBtn = document.querySelector(".like-btn");
        const likesCount = document.querySelector(".likes-count");

        likeBtn.addEventListener("click", function () {
            const eventId = this.dataset.eventId;

            fetch("{% url 'toggle_like' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ event_id: eventId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "liked") {
                    likeBtn.querySelector("i").classList.remove("far");
                    likeBtn.querySelector("i").classList.add("fas", "text-red");
                } else if (data.status === "unliked") {
                    likeBtn.querySelector("i").classList.remove("fas", "text-red");
                    likeBtn.querySelector("i").classList.add("far");
                }
                likesCount.textContent = data.likes_count;
            });
        });
    });
</script>
{% endblock %}
